name: Update Marketplace Index

on:
  push:
    paths:
      - 'presets/**.json' # Trigger kalau ada file JSON baru di folder presets
  workflow_dispatch: # Tombol manual buat trigger

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Create Indexing Script
        run: |
          cat << 'EOF' > indexer.py
          import os
          import json
          import sys

          try:
              index_list = []
              # Ambil variabel dari Environment biar aman
              repo = os.environ.get('GITHUB_REPOSITORY')
              branch = 'main'
              
              presets_dir = 'presets'
              output_file = 'marketplace.json'
              
              print(f"üöÄ Starting indexing for {repo}...")

              if not os.path.exists(presets_dir):
                  print(f"‚ö†Ô∏è Warning: Folder '{presets_dir}' not found. Creating empty index.")
              else:
                  for f in os.listdir(presets_dir):
                      if f.endswith('.json'):
                          file_path = os.path.join(presets_dir, f)
                          try:
                              with open(file_path, 'r', encoding='utf-8') as file:
                                  data = json.load(file)
                                  # Ambil metadata
                                  meta = data.get('meta', {})
                                  
                                  # Tambah field penting buat frontend
                                  meta['id'] = data.get('id', f.replace('.json', ''))
                                  meta['filename'] = f
                                  # URL Download Raw
                                  meta['download_url'] = f'https://raw.githubusercontent.com/{repo}/{branch}/{presets_dir}/{f}'
                                  
                                  # Validasi minimal
                                  if meta.get('name'):
                                      index_list.append(meta)
                                      print(f"‚úÖ Indexed: {meta.get('name')}")
                                  else:
                                      print(f"‚è© Skipped {f}: No name in metadata")
                                      
                          except Exception as e:
                              print(f"‚ùå Error reading {f}: {e}")

              # Urutkan dari yang terbaru
              index_list.sort(key=lambda x: x.get('created_at', 0), reverse=True)
              
              print(f"üì¶ Total items: {len(index_list)}")
              
              with open(output_file, 'w', encoding='utf-8') as f:
                  json.dump(index_list, f, indent=2)
                  
              print("üéâ Indexing complete!")

          except Exception as main_err:
              print(f"üî• CRITICAL ERROR: {main_err}")
              sys.exit(1)
          EOF

      - name: Run Indexer
        run: python3 indexer.py

      - name: Commit and Push
        run: |
          git config --global user.name 'Flowork Bot'
          git config --global user.email 'bot@flowork.cloud'
          
          git add marketplace.json
          
          # Cek apakah ada perubahan sebelum commit
          if git diff --staged --quiet; then
            echo "No changes to marketplace.json"
          else
            git commit -m "Auto-update marketplace index [skip ci]"
            git push
          fi
