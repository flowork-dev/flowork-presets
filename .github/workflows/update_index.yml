name: Update Marketplace Index

on:
  push:
    paths:
      - 'presets/**.json' # Robot bangun kalau ada file JSON baru di folder presets
  workflow_dispatch: # Tombol manual buat memaksa robot kerja

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Generate Marketplace Index
        run: |
          python3 -c "
          import os, json
          
          index_list = []
          # GANTI USER DI BAWAH INI SESUAI USERNAME GITHUB LU BIAR URL-NYA BENER
          # Atau biarkan script ini mendeteksi otomatis:
          repo_full_name = '${{ github.repository }}'
          branch = 'main'
          
          presets_dir = 'presets'
          output_file = 'marketplace.json'
          
          print(f'Scanning {presets_dir} in {repo_full_name}...')

          if os.path.exists(presets_dir):
              for f in os.listdir(presets_dir):
                  if f.endswith('.json'):
                      try:
                          with open(os.path.join(presets_dir, f), 'r') as file:
                              data = json.load(file)
                              # Ambil metadata
                              meta = data.get('meta', {})
                              
                              # Tambah field ID & Download URL buat Frontend
                              meta['id'] = data.get('id', f.replace('.json', ''))
                              meta['filename'] = f
                              meta['download_url'] = f'https://raw.githubusercontent.com/{repo_full_name}/{branch}/{presets_dir}/{f}'
                              
                              # Pastikan ada nama, kalau gak skip
                              if meta.get('name'):
                                  index_list.append(meta)
                                  print(f'Indexed: {meta.get('name')}')
                      except Exception as e:
                          print(f'Error reading {f}: {e}')
          
          # Urutkan dari yang terbaru (berdasarkan created_at)
          index_list.sort(key=lambda x: x.get('created_at', 0), reverse=True)
          
          print(f'Total items: {len(index_list)}')
          
          with open(output_file, 'w') as f:
              json.dump(index_list, f, indent=2)
          "

      - name: Commit and Push Index
        run: |
          git config --global user.name 'Flowork Bot'
          git config --global user.email 'bot@flowork.cloud'
          
          git add marketplace.json
          
          # Cek apakah ada perubahan, kalau ada baru commit
          if git diff --staged --quiet; then
            echo "No changes to marketplace.json"
          else
            git commit -m "Auto-update marketplace.json [skip ci]"
            git push
          fi
