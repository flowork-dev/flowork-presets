name: Update Marketplace Index

on:
  push:
    paths:
      - 'presets/**.json' # Trigger kalau ada preset baru
  workflow_dispatch: # Trigger manual

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          ref: main # Wajib checkout branch main
          fetch-depth: 0 # Ambil semua history buat rebase

      - name: Create Indexing Script
        run: |
          cat << 'EOF' > indexer.py
          import os
          import json
          import sys

          try:
              index_list = []
              repo = os.environ.get('GITHUB_REPOSITORY')
              branch = 'main'
              presets_dir = 'presets'
              output_file = 'marketplace.json'
              
              print(f"üöÄ Starting indexing for {repo}...")

              if not os.path.exists(presets_dir):
                  print(f"‚ö†Ô∏è Warning: Folder '{presets_dir}' not found.")
              else:
                  for f in os.listdir(presets_dir):
                      if f.endswith('.json'):
                          try:
                              with open(os.path.join(presets_dir, f), 'r', encoding='utf-8') as file:
                                  data = json.load(file)
                                  meta = data.get('meta', {})
                                  # Bikin ID dan URL Download
                                  meta['id'] = data.get('id', f.replace('.json', ''))
                                  meta['filename'] = f
                                  meta['download_url'] = f'https://raw.githubusercontent.com/{repo}/{branch}/{presets_dir}/{f}'
                                  
                                  if meta.get('name'):
                                      index_list.append(meta)
                                      print(f"‚úÖ Indexed: {meta.get('name')}")
                          except Exception as e:
                              print(f"‚ùå Error reading {f}: {e}")

              # Urutkan dari yang terbaru
              index_list.sort(key=lambda x: x.get('created_at', 0), reverse=True)
              
              print(f"üì¶ Total items indexed: {len(index_list)}")
              
              with open(output_file, 'w', encoding='utf-8') as f:
                  json.dump(index_list, f, indent=2)

          except Exception as main_err:
              print(f"üî• CRITICAL ERROR: {main_err}")
              sys.exit(1)
          EOF

      - name: Run Indexer
        run: python3 indexer.py

      - name: Commit and Push
        run: |
          git config --global user.name 'Flowork Bot'
          git config --global user.email 'bot@flowork.cloud'
          
          git add marketplace.json
          
          # Cek apakah marketplace.json berubah
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to marketplace.json. Skipping commit."
          else
            git commit -m "Auto-update marketplace index [skip ci]"
            
            # --- JURUS ANTI BENTROK (THE FIX) ---
            echo "üîÑ Pulling latest changes from remote..."
            git pull --rebase origin main
            
            echo "üöÄ Pushing to GitHub..."
            git push origin main
          fi
